# Даша-бот
[Ссылка на GitHub](https://github.com/abakuntzz/whitelist_bot/)  
Данный telegram-бот предназначен для поддержания системы белого списка в чате. Пользователь сможет добавить бота в чат, в котором является админом, и использовать команды.  
|Команда|Функционал|Только админам?|
|-------|----------|:-----------------:|
|```/start```|Выводит приветствие, краткий обзор и рассказывает о ```/help```|-|
|```/help```|Выводит документацию всех команд|-|
|```/list```|Выводит действующий список и статус|-|
|```/add_user @name```|Добавляет пользователя ```name``` в список|+|
|```/remove_user @name```|Удаляет пользователя ```name``` из списка|+|
|```/pause```|Включает режим паузы (включен изначально)|+|
|```/unpause```|Отключает режим паузы|+|
|```/add_all_members```|Добавляет в список всех, кто сейчас в чате|+|
|```/remove_all_members```|Убирает из списка всех, кто сейчас в нём|+|
## Задачи
|Что|Сколько времени|Разработчик|  
|---|:-------------:|:---------:|
|Функционал команд|1 неделя|Арина|
|Взаимодействие с БД|1 неделя|Алина|
|Переход на облачную БД|3 дня|Алина|
|Docker|3 дня|Арина|
|Покрытие тестами|1 неделя|Алина|
|Логирование (опционально)|3 дня|Арина|  
## База данных
![img.png](img.png)
## Примерная иерархия пакетов
```mermaid
  graph TD;
      Main-->Bot;
      Main-->Database;
      Main-->Secrets;
      Bot-->Commands;
      Commands-->Database;
      Database-->Secrets;
```
## Схема взаимодействия
```mermaid
    sequenceDiagram
        participant Пользователь
        participant Админ
        participant Чат
        participant Бот
        participant БазаДанных

        Note over Бот: Инициализация
        Бот->>БазаДанных: Загрузить настройки чата
        БазаДанных-->>Бот: Настройки

        Note over Админ,Чат: Добавление бота в чат
        Админ->>Чат: Добавляет бота
        Чат->>Бот: Сигнал о добавлении
        Бот->>БазаДанных: Создание новой записи

        Note over Бот: Проверка при запуске/активации
        Бот->>Чат: Получить список пользователей
        Чат-->>Бот: Список пользователей
        Бот->>БазаДанных: Получить белый список
        БазаДанных-->>Бот: Белый список
        loop Проверить каждого пользователя
            alt Пользователь не в белом списке
                Бот->>Чат: Кикнуть нарушителя
            end
        end

        Note over Пользователь,Бот: Базовые команды
        Пользователь->>Бот: /start
        Бот-->>Чат: Приветствие, описание и просьба выдать разрешение на кик пользователей

        Пользователь->>Бот: /help
        Бот-->>Чат: Список команд и инструкция

        Пользователь->>Бот: /list
        Бот->>БазаДанных: Получить белый список и статус паузы
        БазаДанных-->>Бот: Белый список и статус паузы
        Бот-->>Чат: Белый список и статус паузы

        Note over Админ,Бот: Настройка
        Админ->>Бот: /pause
        Бот->>БазаДанных: Состояние: Пауза
        Бот-->>Чат: "Белый список на паузе"

        Админ->>Бот: /add_user @name
        Бот->>БазаДанных: Добавить в белый список
        Бот-->>Чат: "Пользователь @name добавлен"

        Админ->>Бот: /remove_user @name
        Бот->>БазаДанных: Удалить из белого списка
        Бот-->>Чат: "Пользователь @name удален из белого списка"
        Бот->>БазаДанных: Узнать статус паузы
        БазаДанных-->>Бот: Статус паузы
        alt Не на паузе
            Бот->>Чат: Проверить, есть ли пользователь в чате
            Чат-->>Бот: Статус пользователя
            alt Пользователь в чате
                Бот->>Чат: Кикнуть пользователя
            end
        end

        Админ->>Бот: /add_all_users
        Бот->>Чат: Получить список пользователей
        Чат-->>Бот: Список пользователей
        Бот->>БазаДанных: Добавить всех в белый список
        Бот-->>Чат: "Все пользователи добавлены в белый список"

        Админ->>Бот: /remove_all_users
        Бот->>БазаДанных: Очистить белый список
        Бот-->>Чат: "Белый список очищен"
        Бот->>БазаДанных: Узнать статус паузы
        БазаДанных-->>Бот: Статус паузы
        alt Не на паузе
            Бот->>Чат: Получить список пользователей
            Чат-->>Бот: Список пользователей
            loop Кикнуть всех пользователей
                Бот->>Чат: Кикнуть пользователя
            end
        end

        Note over Админ,Бот: Активное состояние
        Админ->>Бот: /unpause
        Бот->>БазаДанных: Убрать паузу
        Бот->>Чат: Получить список пользователей
        Чат-->>Бот: Список пользователей
        Бот->>БазаДанных: Получить белый список
        БазаДанных-->>Бот: Белый список
        loop Проверить каждого пользователя при активации
            alt Пользователь не в белом списке
                Бот->>Чат: Кикнуть нарушителя
            end
        end
        Бот-->>Чат: "Режим паузы отключен"

        Note over Чат,Бот: Рабочий режим
        loop Мониторинг новых пользователей
            Чат->>Бот: Новый пользователь вступил
            Бот->>БазаДанных: Узнать статус паузы
            БазаДанных-->>Бот: Статус паузы
            alt Не на паузе
                Бот->>БазаДанных: Получить белый список
                БазаДанных-->>Бот: Белый список
                alt Не в белом списке
                    Бот->>Чат: Кикнуть пользователя
                end
            end
        end
```
